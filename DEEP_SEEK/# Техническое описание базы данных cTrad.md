# Техническое описание базы данных cTrader

## Общая структура

База данных **cTrader** разделена на несколько **схем (schemas)**, каждая из которых отвечает за определённую функциональную область:

1. **meta** — Метаданные и системные представления
2. **trd** — Торговые данные (счета, клиенты, брокеры, ордеры, позиции)
3. **tms** — Time-series данные (бары, индикаторы, технический анализ)
4. **algo** — Алгоритмическая торговля (стратегии, конфигурации, сигналы)
5. **ref** — Справочники (активы, символы, маппинг)
6. **fin** — Финансовые данные (балансы, транзакции, отчёты)
7. **inf** — Информационные/тестовые таблицы

## Основные сущности и связи

### 1. Торговая подсистема (trd)
- **account** — Счета клиентов
  - Связан с: client, currency, accountType, brokers, platforms
- **client** — Клиенты
- **brokers** — Брокеры
- **platforms** — Торговые платформы
- **position** — Открытые позиции
  - Связан с: account, assetMasterTable
- **orders** — Ордеры (рыночные и отложенные)
- **pendingOrder** — Отложенные ордера

### 2. Менеджмент данных (tms)
- **bars** — Исторические бары (цена, время)
  - Ключевые поля: TickerJID, barTime, timeframeID
- **EMA**, **MA** — Технические индикаторы (скользящие средние)
- **Indicators_Momentum** — Моментум-индикаторы (RSI, Stochastic)
- **MarketRegime_*** — Режимы рынка (тренд, волатильность, паттерны)

### 3. Алгоритмическая торговля (algo)
- **strategies** — Торговые стратегии
- **strategy_classes** — Классы стратегий
- **strategy_configurations** — Конфигурации стратегий
- **tradingSignals** — Торговые сигналы
- **tradeLog** — Лог торговых операций
- **strategyTracker** — Трекер запущенных стратегий

### 4. Справочники (ref)
- **assetMasterTable** — Мастер-таблица активов
  - Ключевые поля: ticker, name, lot_size, pip_size
- **assetClasses** — Классы активов
- **SymbolMapping** — Маппинг символов между системами

### 5. Финансы (fin)
- **equity** — Балансы счетов
- **transactions** — Финансовые транзакции
- **TransactionType** — Типы транзакций

## Ключевые связи и внешние ключи

### Основные связи:
1. **account → client** (clientID)
2. **account → currency** (currencyID)
3. **account → accountType** (accountTypeID)
4. **account → brokers** (brokerID)
5. **account → platforms** (platformID)
6. **bars → SymbolMapping** (TickerJID)
7. **strategies → strategy_classes** (strategy_class_id)
8. **position → account** (accountID)
9. **orders → account** (accountID)

## Важные технические особенности

### 1. Идентификация активов
- Используется **TickerJID** как основной идентификатор в time-series данных
- **SymbolMapping** связывает TickerJID с конкретными символами для каждого брокера

### 2. Time-series данные
- Все временные ряды имеют общую структуру:
  - TickerJID (идентификатор инструмента)
  - BarTime (время бара)
  - TimeFrameID (таймфрейм)
  - SourceID (источник данных)

### 3. Алгоритмическая торговля
- Стратегии конфигурируются через **ConfigurationSets** и **ParameterSets**
- **strategyTracker** отслеживает состояние запущенных стратегий
- **tradingSignals** содержит сигналы для исполнения

### 4. Производительность и мониторинг
- **logsJob_*** таблицы для логирования выполнения задач
- Индексы на ключевых полях (TickerJID, BarTime)
- Разделение данных по схемам для изоляции функциональных областей

## Представления (Views)

### Ключевые представления:
1. **positions_v** — агрегированная информация по позициям
2. **strategies_v** — информация о стратегиях с дополнительными данными
3. **vw_Momentum_Signals** — сигналы на основе моментум-индикаторов
4. **EquityProfitView_10min** — прибыль по счетам с агрегацией по 10 минут
5. **strategiesRunning_v** — информация о запущенных стратегиях

## Функции (Table-Valued Functions)

### Основные функции:
1. **fn_GetStrategyConfiguration** — получение конфигурации стратегии
2. **fn_CalculateEMA_ForGroup** — расчёт EMA для группы инструментов
3. **fn_activeTickersTable** — список активных тикеров
4. **getStrategyParameters** — параметры стратегий

## Системные особенности

### Именование объектов:
- `cTrader.[schema].[object_name]` — полное имя объекта
- Соглашение: таблицы в единственном числе, представления с суффиксом `_v`

### Типы данных:
- `decimal(18,6)` — для цен и финансовых величин
- `decimal(18,8)` — для индикаторов
- `datetime` / `datetime2` — для временных меток
- `money` — для денежных сумм

### Значения по умолчанию:
- `getdate()` — текущая дата/время
- `getutcdate()` — текущее UTC время
- `newid()` — генерация GUID

Это описание должно помочь избежать путаницы при работе с базой данных cTrader. Каждая схема имеет чётко определённую зону ответственности, а связи между таблицами следуют логической структуре торговой системы.


2026-01-30 04:00

**ДЕТАЛЬНЫЙ ОТЧЁТ О ПРОДЕЛАННОЙ РАБОТЕ:**

---

### **1. ПРОБЛЕМА И ДИАГНОСТИКА**
- **Исходная проблема:** Стратегия Python не находила созданные позиции
- **Причина:** Python проверял позиции сразу после отправки сигнала, а робот не успевал их создать
- **Root cause:** Архитектура с множеством таймеров и избыточными проверками

---

### **2. НОВАЯ АРХИТЕКТУРА**
**Принципы:**
- **Один таймер 500ms** во фреймворке
- **Event-driven проверки** (только когда есть события)
- **Минимальные логи** (только при действиях)
- **Централизованная инициализация**

---

### **3. СОЗДАНИЕ ANFRAMEWORK**
**Структура:**
- `StrategyBase` - базовый класс всех стратегий
- `ConnectionProvider` - пул соединений с БД
- **Новый цикл:**
  - Termination check
  - Force close time check  
  - Position confirmation (только если ждём)
  - Bar/signal processing (раз в таймфрейм)

---

### **4. БАЗА ДАННЫХ**
**Добавлено/изменено:**
1. **`algo.sp_strategyRegister`** - регистрирует стратегию и возвращает конфигурацию JSON
2. **`algo.strategyEventsType`** - таблица событий стратегии (start/stop/error/termination/signal)
3. **`logs.strategyExecution.EventTypeID`** - связь с событиями стратегии
4. **`signalTypeID` → NULLABLE** - только для торговых сигналов

---

### **5. НОВАЯ СТРАТЕГИЯ mtfTrend.py**
**Реализовано:**
- ✅ Наследование от `StrategyBase`
- ✅ Автоматическая регистрация при создании
- ✅ Загрузка конфигурации из БД
- ✅ Логирование старта стратегии
- ✅ Извлечение параметров (`_setup_parameters`)

**Параметры для XAUUSD:**
- Ticker JID: 13
- Timeframes: signal=1 (M1), confirmation=3 (M15), trend=5 (H1)
- Volume: 0.02 lots
- Trading hours: 00:00 - 22:00 UTC
- Broker: 2, Platform: 1

---

### **6. WORKFLOW СТРАТЕГИИ**
**Текущий статус:**
1. **Запуск** → Регистрация в БД → Логирование 'start'
2. **Параметры** загружены в память
3. **Таймер 500ms** готов к работе
4. **Абстрактные методы** требуют реализации

**Что осталось реализовать:**
- `check_termination()` - проверка принудительной остановки
- `check_force_close()` - проверка времени закрытия (22:00 UTC)
- `process_bars_and_signals()` - основная логика стратегии
- Управление позициями (открытие/реверс/закрытие)

---

### **7. КЛЮЧЕВЫЕ ИЗМЕНЕНИЯ В ЛОГИКЕ**
**От старой архитектуры:**
- ❌ Множество таймеров (30s, 60s, 100ms) → ✅ Один таймер 500ms
- ❌ Постоянные проверки позиций → ✅ Проверка только при ожидании
- ❌ Heartbeat каждые 60s → ✅ Мониторинг по событиям
- ❌ Регулярная печать статуса → ✅ Логи только при действиях
- ❌ Стратегия сама управляет циклом → ✅ Фреймворк управляет циклом

---

### **8. СТАТУС БАЗЫ ДАННЫХ**
**Записи созданы:**
- `algo.strategyTracker`: configID=1, GUID=C422176E-2F67-4BAE-9BEA-6C5D8BD598C8
- `logs.strategyExecution`: EventTypeID=1 (start), volume=0.02, trade_uuid=GUID

**Готово к торговле:**
- ✅ Конфигурация загружена
- ✅ Регистрация выполнена
- ✅ Логирование работает
- ⏳ Ожидает реализации торговой логики

---

### **9. СЛЕДУЮЩИЕ ШАГИ**
1. Реализация `check_termination()` и `check_force_close()`
2. Реализация основной логики `process_bars_and_signals()`
3. Добавление управления позициями
4. Тестирование с реальными сигналами
5. Мониторинг производительности

---

**ИТОГ:** Создана новая, более эффективная архитектура, решена проблема подтверждения позиций, стратегия готова к реализации торговой логики.