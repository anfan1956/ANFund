# Техническое описание базы данных cTrader

## Общая структура

База данных **cTrader** разделена на несколько **схем (schemas)**, каждая из которых отвечает за определённую функциональную область:

1. **meta** — Метаданные и системные представления
2. **trd** — Торговые данные (счета, клиенты, брокеры, ордеры, позиции)
3. **tms** — Time-series данные (бары, индикаторы, технический анализ)
4. **algo** — Алгоритмическая торговля (стратегии, конфигурации, сигналы)
5. **ref** — Справочники (активы, символы, маппинг)
6. **fin** — Финансовые данные (балансы, транзакции, отчёты)
7. **inf** — Информационные/тестовые таблицы

## Основные сущности и связи

### 1. Торговая подсистема (trd)
- **account** — Счета клиентов
  - Связан с: client, currency, accountType, brokers, platforms
- **client** — Клиенты
- **brokers** — Брокеры
- **platforms** — Торговые платформы
- **position** — Открытые позиции
  - Связан с: account, assetMasterTable
- **orders** — Ордеры (рыночные и отложенные)
- **pendingOrder** — Отложенные ордера

### 2. Менеджмент данных (tms)
- **bars** — Исторические бары (цена, время)
  - Ключевые поля: TickerJID, barTime, timeframeID
- **EMA**, **MA** — Технические индикаторы (скользящие средние)
- **Indicators_Momentum** — Моментум-индикаторы (RSI, Stochastic)
- **MarketRegime_*** — Режимы рынка (тренд, волатильность, паттерны)

### 3. Алгоритмическая торговля (algo)
- **strategies** — Торговые стратегии
- **strategy_classes** — Классы стратегий
- **strategy_configurations** — Конфигурации стратегий
- **tradingSignals** — Торговые сигналы
- **tradeLog** — Лог торговых операций
- **strategyTracker** — Трекер запущенных стратегий

### 4. Справочники (ref)
- **assetMasterTable** — Мастер-таблица активов
  - Ключевые поля: ticker, name, lot_size, pip_size
- **assetClasses** — Классы активов
- **SymbolMapping** — Маппинг символов между системами

### 5. Финансы (fin)
- **equity** — Балансы счетов
- **transactions** — Финансовые транзакции
- **TransactionType** — Типы транзакций

## Ключевые связи и внешние ключи

### Основные связи:
1. **account → client** (clientID)
2. **account → currency** (currencyID)
3. **account → accountType** (accountTypeID)
4. **account → brokers** (brokerID)
5. **account → platforms** (platformID)
6. **bars → SymbolMapping** (TickerJID)
7. **strategies → strategy_classes** (strategy_class_id)
8. **position → account** (accountID)
9. **orders → account** (accountID)

## Важные технические особенности

### 1. Идентификация активов
- Используется **TickerJID** как основной идентификатор в time-series данных
- **SymbolMapping** связывает TickerJID с конкретными символами для каждого брокера

### 2. Time-series данные
- Все временные ряды имеют общую структуру:
  - TickerJID (идентификатор инструмента)
  - BarTime (время бара)
  - TimeFrameID (таймфрейм)
  - SourceID (источник данных)

### 3. Алгоритмическая торговля
- Стратегии конфигурируются через **ConfigurationSets** и **ParameterSets**
- **strategyTracker** отслеживает состояние запущенных стратегий
- **tradingSignals** содержит сигналы для исполнения

### 4. Производительность и мониторинг
- **logsJob_*** таблицы для логирования выполнения задач
- Индексы на ключевых полях (TickerJID, BarTime)
- Разделение данных по схемам для изоляции функциональных областей

## Представления (Views)

### Ключевые представления:
1. **positions_v** — агрегированная информация по позициям
2. **strategies_v** — информация о стратегиях с дополнительными данными
3. **vw_Momentum_Signals** — сигналы на основе моментум-индикаторов
4. **EquityProfitView_10min** — прибыль по счетам с агрегацией по 10 минут
5. **strategiesRunning_v** — информация о запущенных стратегиях

## Функции (Table-Valued Functions)

### Основные функции:
1. **fn_GetStrategyConfiguration** — получение конфигурации стратегии
2. **fn_CalculateEMA_ForGroup** — расчёт EMA для группы инструментов
3. **fn_activeTickersTable** — список активных тикеров
4. **getStrategyParameters** — параметры стратегий

## Системные особенности

### Именование объектов:
- `cTrader.[schema].[object_name]` — полное имя объекта
- Соглашение: таблицы в единственном числе, представления с суффиксом `_v`

### Типы данных:
- `decimal(18,6)` — для цен и финансовых величин
- `decimal(18,8)` — для индикаторов
- `datetime` / `datetime2` — для временных меток
- `money` — для денежных сумм

### Значения по умолчанию:
- `getdate()` — текущая дата/время
- `getutcdate()` — текущее UTC время
- `newid()` — генерация GUID

Это описание должно помочь избежать путаницы при работе с базой данных cTrader. Каждая схема имеет чётко определённую зону ответственности, а связи между таблицами следуют логической структуре торговой системы.